<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    </head>
    <body>
        
        <div class="container">
            <div class="row">
                <h1>Connected as <%= name %></h1>
                <div class="col-md-6 offset-md-3 col-sm-12">
                    <h1 class="text-center">
                        MongoChat 
                       
                    </h1>
                    <div id="status"></div>
                    <div id="chat">
                        <button id="clear" class="btn btn-danger">Delete Chat</button>
                        <br>
                        <div class="card">
                            <div id="messages" class="card-block">
    
                            </div>
                        </div>
                        <br>
                        <textarea  id="textarea" class="form-control" placeholder="Enter message..."></textarea>
                        <button id="send" class="btn btn-danger">Send</button>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>

        <script>
           (function(){
            var element = function(id){
                return document.getElementById(id);
            }

            // Get Elements
            var status = element('status');
            var messages = element('messages');
            var textarea = element('textarea');
            var username = element('username');
            var clearBtn = element('clear');
            var sendBtn = element('send');
            // Set default status
            var statusDefault = status.textContent;

            var setStatus = function(s){
                // Set status
                status.textContent = s;

                if(s !== statusDefault){
                    var delay = setTimeout(function(){
                        setStatus(statusDefault);
                    }, 4000);
                }
            }
            if(socket === undefined){
                var socket = io.connect('http://127.0.0.1:4000');

            }
            // Connect to socket.io

            // Check for connection
            if(socket !== undefined){
                //socket.setMaxListeners(2);
                console.log('Connected to socket...');

                socket.on('connect', (host, port) => { 
                    console.log(`client connected to ${host}:${port}`); 
                    socket.emit('authentication', {username: "<%= username%>", password: "<%= password%>"});
                    socket.on('unauthorized', function(err){
                        if(err){
                            console.log("There was an error with the authentication:", err.message);
                        }
                    });
                   // console.log(req);
                   // client.write(‘Hello, I am ${client.address().address}’); 
                   
                }); 
                // socket.on('disconnect', function () {
                //     socket.emit('user disconnected');
                // });
                // Handle Output
               
                
                socket.on('output', function(data){
                    if(data.length>0){
                        console.log(data.length);
                        console.log("<<<<<<<<<<<<<<<<<<<<<<<<<< output chat ejs file>>>>>>>>>>>>>>>>>>>>>>>>>>.")
                        console.log("data = ",data);
                        // for(var x = 0;x < data.length;x++){
                            // Build out message div
                            var message = document.createElement('div');
                            message.setAttribute('class', 'chat-message');
                            message.textContent = data[0].sender+": "+data[0].message;
                            messages.appendChild(message);
                            messages.insertBefore(message, messages.lastChild);
                       // }
                    }
                });

                // Get Status From Server
                socket.on('status', function(data){
                    // get message status
                    setStatus((typeof data === 'object')? data.message : data);

                    // If status is clear, clear text
                    if(data.clear){
                        textarea.value = '';
                    }
                });

                // Handle Input
                textarea.addEventListener('keydown', function(event){
                    if(event.which === 13){
                        // Emit to server input
                        socket.emit('input', {
                            name:"<%= _id %>",
                            message:textarea.value
                        }); 
                    }
                });

            

                $("#send").unbind()
                .on('click',function(e){
                    e.preventDefault();
                    console.log("<<<<<<<<<<<===== click ========>>>>>>>>>>>>");
                    socket.emit('input', {
                            name:"<%= _id %>",
                            message:textarea.value
                        });
                   e.preventDefault();
                });

                // Handle Chat Clear
                clearBtn.addEventListener('click', function(){
                    socket.emit('clear');
                });

                // Clear Message
                socket.on('cleared', function(){
                    messages.textContent = '';
                });
            
            }

        })();
    </script>
    </body>
</html>